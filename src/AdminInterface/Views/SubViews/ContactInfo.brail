<style>
	.ContactInfoCell
	{
		width: 25%;
		padding-left: 10px;
		vertical-align: top;
	}
</style>

<script>
    function setContactTypeClass(rowId, className) 
    {
        var textBox = document.getElementById("contacts[" + rowId + "].ContactText");
        textBox.setAttribute("class", className);
    }
       
    function setContactType(rowId)
    {
        var comboBox = document.getElementById("contacts[" + rowId + "].Type");
        var index = comboBox.selectedIndex;
        if (index == 0)
        {
            setContactTypeClass(rowId, "email");
            var text = $("#contactActionLink" + rowId).attr("name");
            $("#contactActionLink" + rowId).attr("href", "mailto:" + text);
            $("#contactActionImage" + rowId).attr("src", "${siteroot}/Images/email.png");
        }
        else if (index == 1)
        {
            setContactTypeClass(rowId, "phone");
            var text = $("#contactActionLink" + rowId).attr("name");
            $("#contactActionLink" + rowId).attr("href", "sip:8" + text.replace('-', ''));
            $("#contactActionImage" + rowId).attr("src", "${siteroot}/Images/sipphone.png");
        }
    }

    function deleteContactRow(clientId, rowId) {
        $("#row" + rowId).remove();
        if (rowId > 0)
        {
            $("#Holder" + clientId).append("<input type='hidden' name='deletedContacts[" + rowId + "].Id' id='contacts[" + rowId + "].Id' value='" + rowId + "' />");
        }
    }

    function addContactRow(rowId, clientId, text, comment, contactType) {
		var imageLink = "<a id='contactActionLink" + rowId + "' href='' name='" + text + "'><img id='contactActionImage" + rowId + "' src='${siteroot}/Images/email.png' border=0 /></a>";

        $("#Holder" + clientId).append("<tr id='row" + rowId + "' name='row" + rowId + "' valign='top'>" +
			"<td align='right'>" + imageLink + "</td>" +
            "<td class='ContactInfoCell' align='right'>" +
                "<input type='hidden' name='contacts[" + rowId + "].Id' id='contacts[" + rowId + "].Id' value='" + rowId + "'/>" +
                "<select style='width: 100%;' name='contacts[" + rowId + "].Type' id='contacts[" + rowId + "].Type' onchange='setContactType(" + rowId + ")'>" +
                    "<option value='${EmailContactType}' selected>Email</option>" +
                    "<option value='${PhoneContactType}'>Телефон</option>" + 
                "</select>" +
                "<p>Примечание:</p>" +
            "</td>" +
            "<td style = 'width: 50%;padding-left: 10px;'>" +
                "<input type='text' style='width: 100%' class='email' name='contacts[" + rowId + "].ContactText' id='contacts[" + rowId + "].ContactText' value='" + text + "'/>" +
                "<input type='text' style='width: 100%' name='contacts[" + rowId + "].Comment' id='contacts[" + rowId + "].Comment' value='" + comment + "'/>" +
            "</td>" +
            "<td style='vertical-align: top;padding-left: 10px'>" +
                "<input type='button' value='Удалить' name='contacts[" + rowId + "].Delete' onclick='deleteContactRow(" + clientId + "," + rowId + ")' />" +
            "</td>" +
        "</tr>");
        
        if (contactType == '${EmailContactType}')
        {
            var comboBox = document.getElementById("contacts[" + rowId + "].Type");
            comboBox.selectedIndex = 0;
            setContactType(rowId);
        }
        else if (contactType == '${PhoneContactType}')
        {
            var comboBox = document.getElementById("contacts[" + rowId + "].Type");
            comboBox.selectedIndex = 1;
            setContactType(rowId);
        }
    }
    
    var insertId = 0;
    $(document).ready(function(){
        <% if IsDefined('ContactGroup'): %>
            <% for contact in ContactGroup.Contacts: %>
                addContactRow(${contact.Id}, ${client.Id}, '${contact.ContactText}', '${contact.Comment}', '${contact.Type}');
            <% end %>
        <% end %>
        $("#mainForm").validate();
    });

    $(function() {
        $.validator.addMethod("phone", function(value, element) {
            if (value.toString().length > 0) {
                res = /^(\d{3,4})-(\d{6,7})(\*\d{3})?$/.test(value)
                return res;
            }
            return true;
        }, "Некорректный телефонный номер");

        $.validator.addMethod("email", function(value, element) {
            if (value.toString().length > 0) {
                res = /^([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)$/.test(value)
                return res;
            }
            return true;
        }, "Некорректный адрес электронной почты");  
    });
</script>
		
<div class=contextual>
    <a id="addContactLink${client.Id}" class="icon icon-add" href="javascript:" onclick="addContactRow(--insertId, ${client.Id}, '', '')">Добавить</a>
</div>		    
<h3>Контактная информация</h3>
<table width="100%" cellspacing="5">
    <tr>
        <td>
            <table name="Holder${client.Id}" id="Holder${client.Id}" style="width: 100%">
            </table>
        </td>
    </tr>
</table>
